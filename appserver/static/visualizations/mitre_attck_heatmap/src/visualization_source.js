"use strict";define(["jquery","underscore","api/SplunkVisualizationBase","api/SplunkVisualizationUtils","enterpriseAttack","icsAttack","mobileAttack"],(function(t,a,e,r,n,i,c){return e.extend({initialize:function(){e.prototype.initialize.apply(this,arguments),this.$el=t(this.el),this.$el.addClass("mitre-container"),this.colorMap=[{pct:0,color:{r:99,g:190,b:123}},{pct:50,color:{r:255,g:213,b:132}},{pct:100,color:{r:248,g:105,b:107}}]},formatData:function(t){if(t.rows.length<1)return!1;if(t.rows[0].length<2)throw new e.VisualizationError("Search results must have at least 2 fields: id, count");return t},updateView:function(a,e){if(a){this.$el.empty();var s=this,o=this.colorMap,l=e[this.getPropertyNamespaceInfo().propertyNamespace+"theme"]||"light",d=e[this.getPropertyNamespaceInfo().propertyNamespace+"startColor"]||"#53a051",m=e[this.getPropertyNamespaceInfo().propertyNamespace+"midColor"]||"#f8be34",p=e[this.getPropertyNamespaceInfo().propertyNamespace+"endColor"]||"#dc4e41",h=e[this.getPropertyNamespaceInfo().propertyNamespace+"startVal"]||0,u=e[this.getPropertyNamespaceInfo().propertyNamespace+"endVal"]||100,v=e[this.getPropertyNamespaceInfo().propertyNamespace+"display"]||"id",f=r.escapeHtml(e[this.getPropertyNamespaceInfo().propertyNamespace+"legendTitle"])||a.fields[1].name,g=e[this.getPropertyNamespaceInfo().propertyNamespace+"sortKey"]||"data-id",b=e[this.getPropertyNamespaceInfo().propertyNamespace+"sortOrder"]||"asc",y=e[this.getPropertyNamespaceInfo().propertyNamespace+"hideNull"]||"no",_=(e[this.getPropertyNamespaceInfo().propertyNamespace+"matrix"]||"enterprise::").split("::"),q=_[0],N=_[1].split(","),w={};w="ics"==q?i:"mobile"==q?c:n,this.$el.attr("class","").addClass(l),o[0].color=this._hexToRgb(d),o[1].color=this._hexToRgb(m),o[2].color=this._hexToRgb(p);var k=t('<div class="mtr-viz-container"></div>'),I=t('\n            <div class="mtr-legend">\n                <div class="mtr-legend-title">'+f+'</div>\n                <div class="mtr-legend-meter-container">    \n                    <div class="mtr-legend-meter"></div>\n                </div>\n                <div class="mtr-legend-val">\n                    <span>'+h+"</span>\n                    <span>"+(u-h)/2+"</span>\n                    <span>"+u+"</span>\n                </div>\n            </div>\n        "),x="(45deg, "+d+" 0%, "+m+" 50%, "+p+" 100%)";t(".mtr-legend-meter",I).css("background","-moz-linear-gradient"+x).css("background","-webkit-linear-gradient"+x).css("background","linear-gradient"+x),I.hover((function(){t(".mtr-legend-meter-container",this).append(t('<div class="mtr-legend-cursor"></div'))}),(function(){t(".mtr-legend-cursor").remove(),t(".mtr-technique").removeClass("focused").removeClass("defocused")}));I.mousemove((function(a){if(a.preventDefault(),Date.now()>100){var e=t(".mtr-legend-cursor",this),r=e.width(),n=t(this).width(),i=a.pageX-t(this).offset().left;if(i<=n&&i>0){var c=i-r/2;e.css("left",c+"px");var s=c/n*(u-h),o=(c+r)/n*(u-h);t(".mtr-technique").each((function(){var a=t(this).attr("data-value");a&&a>=s&&a<=o?t(this).addClass("focused").removeClass("defocused"):t(this).removeClass("focused").addClass("defocused")}))}}})),w.tactics.forEach((function(a){$tactic_col=t('<div class="mtr-tactic-col" data-id="'.concat(a.id,'" data-name="').concat(a.name,'" data-tactic="').concat(a.short_name,'">')),$tactic_col.appendTo(k).append('\n                    <div class="mtr-tactic">\n                        <div class="mtr-tactic-title">'.concat(a.name,'</div>\n                        <div class="mtr-meter-container">\n                            <div class="mtr-meter-fill">\n                                <div class="mtr-stats-container">\n                                    <div class="mtr-total mtr-stat">\n                                        <div class="mtr-stats-label">Total</div>\n                                        <div class="mtr-stats-val"></div>\n                                    </div>\n                                    <div class="mtr-count mtr-stat">\n                                        <div class="mtr-stats-label">Unique Techniques</div>\n                                        <div class="mtr-stats-val"></div>\n                                    </div>\n                                    <div class="mtr-mean mtr-stat">\n                                        <div class="mtr-stats-label">Average per Technique</div>\n                                        <div class="mtr-stats-val"></div>\n                                    </div>\n                                </div>\n                            </div>\n                        </div>\n                    </div>\n                    <div class="mtr-technique-col"></div>\n            ')),t(".mtr-tactic-title",k).click((function(a){drilldown_data={mtr_tactic:t(this).parents(".mtr-tactic-col").attr("data-name")},s._drilldown(drilldown_data,a)}))})),w.techniques.forEach((function(a){if(console.log(a),console.log("\n                selected platform: ".concat(N,"\n                technique platform: ").concat(a.platform,"\n            ")),""==N||!("platform"in a)||N.some((function(t){return a.platform.indexOf(t)>=0}))){var e="id"==v?a.id:a.name,r=t('\n                <div class="mtr-technique-container mtr-display-'.concat(v,'" data-id="').concat(a.id,'">\n                    <div class="mtr-technique" data-id="').concat(a.id,'" data-name="').concat(a.name,'" data-url="').concat(a.url,'">\n                        <span>').concat(e,'</span>\n                    </div>\n                    <div class="mtr-sub-technique-container mtr-display-').concat(v,'""></div>\n                </div>\n            '));a.tactics.forEach((function(a){r.clone().prependTo(t('.mtr-tactic-col[data-tactic="'.concat(a,'"] .mtr-technique-col'),k))}))}})),w.sub_techniques.forEach((function(a){if(""==N||!("platform"in a)||N.some((function(t){return a.platform.indexOf(t)>=0}))){var e="id"==v?a.short_id:a.name;t('.mtr-technique-container[data-id="'.concat(a.technique,'"]'),k).each((function(){t(".mtr-sub-technique-container",t(this)).append('\n                    <div class="mtr-sub-technique mtr-display-'.concat(v,'" data-id="').concat(a.id,'" data-name="').concat(a.name,'" data-url="').concat(a.url,'">\n                        <span>').concat(e,"</span>\n                    </div>\n                "))}))}})),a.rows.forEach((function(e){var n=r.escapeHtml(e[0]),i=r.escapeHtml(e[1]),c=t('.mtr-technique[data-id="'.concat(n,'"], .mtr-sub-technique[data-id="').concat(n,'"]'),k);if(c.click((function(r){drilldown_data={},e.forEach((function(t,e){drilldown_data[a.fields[e].name]=t})),drilldown_data.mtr_technique=t(this).closest(".mtr-technique-container").attr("data-id"),drilldown_data.mtr_tactic=t(this).closest(".mtr-tactic-col").attr("data-id"),console.log(drilldown_data),s._drilldown(drilldown_data,r)})),c&&i&&""!=i&&null!=i&&!isNaN(i)){var o=s._getPercent(h,u,i),l=s._getColor(o),d=r.escapeHtml(e[2])||"";o<2&&(o=2),c.attr("data-value",i),c.attr("data-percent",o),c.attr("data-desc",d),c.css("background",l.background).css("color",l.foreground)}})),t(".mtr-technique, .mtr-sub-technique",k).hover((function(e){var r=t(this).attr("data-id"),n=t(this).attr("data-name"),i=parseInt(t(this).attr("data-percent"))||"",c=t(this).attr("data-desc")||"",o=parseInt(t(this).attr("data-value"))||"",l=t(this).attr("data-url")||"",d=s._getColor(i);i<2&&(i=2);var m=t('\n                <div class="mtr-technique-tooltip">\n                    <div class="mtr-id">'.concat(r,'</div>\n                    <div class="mtr-name">').concat(n,'</div>\n                    <div class="mtr-meter-container">\n                        <div class="mtr-meter-fill"></div>\n                    </div>\n                    <div class="mtr-label"></div>\n                    <div class="mtr-val">').concat(o,'</div>\n                    <div class="mtr-desc"></div>\n                    <div class="mtr-ref"><a target="_blank" href="').concat(l,'">').concat(l,' <i class="icon-external"></i></a></div>\n                </div>\n            '));t(this).offset().left>t(window).width()-400?m.addClass("mtr-technique-tooltip-left"):m.addClass("mtr-technique-tooltip-right");var p="",h=256;if(c.length>h){var u=c.substr(0,h),v=c.substr(h,c.length-h);u=u.split("\\n").join("</p><p>"),v=v.split("\\n").join("</p><p>"),p="<p>".concat(u,' <span class="more-elipses">...</span><span class="more-content">').concat(v,'</span><a href="#" class="more-link">Show more</a></p>')}else p=c.split("\\n").join("</p><p>");t(".mtr-desc",m).append(p),t(".more-link",m).click((function(){return t(".more-elipses",m).hide(),t(".more-content",m).show(),t(".more-link",m).hide(),!1})),m.appendTo(t(this)),o&&(t(".mtr-label",m).text(a.fields[1].name),t(".mtr-meter-fill",m).css("background",d.background).animate({width:t(this).attr("data-percent")+"%"},50,"linear"),d.luminance<.1&&t(".mtr-meter-container",m).addClass("dark"))}),(function(){t(".mtr-technique-tooltip").remove()})),t(".mtr-tactic-col",k).each((function(){var a=0,e=0,r=0;if(t(".mtr-technique",this).each((function(){var n=t(this).attr("data-value");n||"yes"!=y?(r+=1,n&&!isNaN(n)&&(a+=+n,e+=1)):t(this).parent().remove()})),0!=r||"yes"!=y){var n=Math.round(a/e),i=Math.round(e/r*100);n||(n=0),i||(i=0);var c=s._getPercent(h,u,n),o=s._getColor(c);c<2&&(c=2),t(".mtr-tactic .mtr-meter-fill",this).css("background",o.background).css("color",o.foreground).css("width",c+"%"),t(".mtr-tactic .mtr-stat",this).css("background",o.background).css("color",o.foreground).css("border-color",o.foreground),t(".mtr-tactic .mtr-total .mtr-stats-val",this).text(a.toLocaleString()),t(".mtr-tactic .mtr-count .mtr-stats-val",this).text(e.toLocaleString()+" (".concat(i,"%)")),t(".mtr-tactic .mtr-mean .mtr-stats-val",this).text(n.toLocaleString())}else t(this).remove()})),t(".mtr-technique-col",k).each((function(){s._sortElements(t(this),g,b),t(this).append('\n                <div class="mtr-technique-container mtr-display-'.concat(v,'">\n                    <div class="mtr-technique mtr-placeholder mtr-display-').concat(v,'">\n                        <div class="mtr-technique-title">T0000</div>\n                    </div>\n                </div>\n                <div class="mtr-technique-container mtr-display-').concat(v,'">\n                    <div class="mtr-technique mtr-placeholder mtr-display-').concat(v,'">\n                        <div class="mtr-technique-title">T0000</div>\n                    </div>\n                </div>\n            '))})),k.appendTo(this.$el),I.appendTo(this.$el)}},getInitialDataParams:function(){return{outputMode:e.ROW_MAJOR_OUTPUT_MODE}},reflow:function(){},_getPercent:function(t,a,e){var r=Math.round(100*(e-t)/(a-t));return r>100&&(r=100),r<0&&(r=0),r},_hexToRgb:function(t){var a=0,e=0,r=0;return 4==t.length?(a="0x"+t[1]+t[1],e="0x"+t[2]+t[2],r="0x"+t[3]+t[3]):7==t.length&&(a="0x"+t[1]+t[2],e="0x"+t[3]+t[4],r="0x"+t[5]+t[6]),{r:a,g:e,b:r}},_getColor:function(t){for(var a=1;a<this.colorMap.length-1&&!(t<this.colorMap[a].pct);a++);var e=this.colorMap[a-1],r=this.colorMap[a],n=r.pct-e.pct,i=(t-e.pct)/n,c=1-i,s=i,o={r:Math.floor(e.color.r*c+r.color.r*s),g:Math.floor(e.color.g*c+r.color.g*s),b:Math.floor(e.color.b*c+r.color.b*s)},l=(.299*o.r+.587*o.g+.114*o.b)/255,d=l>.65?"rgb(0,0,0)":"rgb(255,255,255)";return{background:"rgb("+[o.r,o.g,o.b].join(",")+")",luminance:l,foreground:d}},_sortElements:function(a,e,r){var n="asc"==r?1:-1;$children=a.children().sort((function(a,r){var i=t(a),c=t(r);return"data-id"==e||"data-name"==e?n*(i.attr(e)<c.attr(e)?-1:1):"data-value"==e?(aVal=parseInt(i.attr(e)),bVal=parseInt(c.attr(e)),Number.isInteger(aVal)||(aVal=-1),Number.isInteger(bVal)||(bVal=-1),n*(aVal<bVal?-1:1)):0})),a.append($children)},_drilldown:function(t,a){this.drilldown({action:e.FIELD_VALUE_DRILLDOWN,data:t},a)}})}));