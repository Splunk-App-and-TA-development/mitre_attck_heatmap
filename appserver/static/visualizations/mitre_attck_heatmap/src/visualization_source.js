"use strict";define(["jquery","underscore","api/SplunkVisualizationBase","api/SplunkVisualizationUtils","enterpriseAttack","icsAttack","mobileAttack"],(function(t,a,e,r,n,i,c){return e.extend({initialize:function(){e.prototype.initialize.apply(this,arguments),this.$el=t(this.el),this.animate=!1,this.$el.addClass("mitre-container"),this.colorMap=[{pct:0,color:{r:99,g:190,b:123}},{pct:50,color:{r:255,g:213,b:132}},{pct:100,color:{r:248,g:105,b:107}}]},formatData:function(t){if(t.rows.length<1)return!1;if(t.rows[0].length<2)throw new e.VisualizationError("Search results must have at least 2 fields: id, count");return t},updateView:function(a,e){if(a){this.$el.empty();var s=this,o=this.colorMap,l=r.normalizeBoolean(e[this.getPropertyNamespaceInfo().propertyNamespace+"animate"]||"no"),d=e[this.getPropertyNamespaceInfo().propertyNamespace+"duration"]||300,m=r.getCurrentTheme(),u=e[this.getPropertyNamespaceInfo().propertyNamespace+"startColor"]||"#53a051",p=e[this.getPropertyNamespaceInfo().propertyNamespace+"midColor"]||"#f8be34",h=e[this.getPropertyNamespaceInfo().propertyNamespace+"endColor"]||"#dc4e41",v=e[this.getPropertyNamespaceInfo().propertyNamespace+"startVal"]||0,f=e[this.getPropertyNamespaceInfo().propertyNamespace+"endVal"]||100,g=e[this.getPropertyNamespaceInfo().propertyNamespace+"display"]||"id",b=r.escapeHtml(e[this.getPropertyNamespaceInfo().propertyNamespace+"legendTitle"])||a.fields[1].name,q=e[this.getPropertyNamespaceInfo().propertyNamespace+"sortKey"]||"data-id",_=e[this.getPropertyNamespaceInfo().propertyNamespace+"sortOrder"]||"asc",y=r.normalizeBoolean(e[this.getPropertyNamespaceInfo().propertyNamespace+"hideNull"]||"no"),N=r.normalizeBoolean(e[this.getPropertyNamespaceInfo().propertyNamespace+"showSubTechniques"]||"yes"),w=(e[this.getPropertyNamespaceInfo().propertyNamespace+"matrix"]||"enterprise::").split("::"),k=w[0],C=w[1].split(","),I={};s.animate=l,I="ics"==k?i:"mobile"==k?c:n,this.$el.attr("class","").addClass(m),o[0].color=this._hexToRgb(u),o[1].color=this._hexToRgb(p),o[2].color=this._hexToRgb(h);var x=t('<div class="mtr-viz-container"></div>'),P=t('\n            <div class="mtr-legend">\n                <div class="mtr-legend-title">'+b+'</div>\n                <div class="mtr-legend-meter-container">    \n                    <div class="mtr-legend-meter"></div>\n                </div>\n                <div class="mtr-legend-val">\n                    <span>'+v+"</span>\n                    <span>"+(f-v)/2+"</span>\n                    <span>"+f+"</span>\n                </div>\n            </div>\n        "),T="(45deg, "+u+" 0%, "+p+" 50%, "+h+" 100%)";t(".mtr-legend-meter",P).css("background","-moz-linear-gradient"+T).css("background","-webkit-linear-gradient"+T).css("background","linear-gradient"+T),P.hover((function(){t(".mtr-legend-meter-container",this).append(t('<div class="mtr-legend-cursor"></div'))}),(function(){t(".mtr-legend-cursor").remove(),t(".mtr-technique").removeClass("focused").removeClass("defocused")}));if(P.mousemove((function(a){if(a.preventDefault(),Date.now()>100){var e=t(".mtr-legend-cursor",this),r=e.width(),n=t(this).width(),i=a.pageX-t(this).offset().left;if(i<=n&&i>0){var c=i-r/2;e.css("left",c+"px");var o=c/n*(f-v),l=(c+r)/n*(f-v);s._setAnimationClass(o,l)}}})),I.tactics.forEach((function(a){$tactic_col=t('<div class="mtr-tactic-col" data-id="'.concat(a.id,'" data-name="').concat(a.name,'" data-tactic="').concat(a.short_name,'">')),$tactic_col.appendTo(x).append('\n                    <div class="mtr-tactic">\n                        <div class="mtr-tactic-title">'.concat(a.name,'</div>\n                        <div class="mtr-meter-container">\n                            <div class="mtr-meter-fill">\n                                <div class="mtr-stats-container">\n                                    <div class="mtr-total mtr-stat">\n                                        <div class="mtr-stats-label">Total</div>\n                                        <div class="mtr-stats-val"></div>\n                                    </div>\n                                    <div class="mtr-count mtr-stat">\n                                        <div class="mtr-stats-label">Unique Techniques</div>\n                                        <div class="mtr-stats-val"></div>\n                                    </div>\n                                    <div class="mtr-mean mtr-stat">\n                                        <div class="mtr-stats-label">Average per Technique</div>\n                                        <div class="mtr-stats-val"></div>\n                                    </div>\n                                </div>\n                            </div>\n                        </div>\n                    </div>\n                    <div class="mtr-technique-col"></div>\n            ')),t(".mtr-tactic-title",x).click((function(a){drilldown_data={mtr_tactic:t(this).parents(".mtr-tactic-col").attr("data-name")},s._drilldown(drilldown_data,a)}))})),I.techniques.forEach((function(a){if(""==C||!("platform"in a)||C.some((function(t){return a.platform.indexOf(t)>=0}))){var e="id"==g?a.id:a.name,r=t('\n                <div class="mtr-technique-container mtr-display-'.concat(g,'" data-id="').concat(a.id,'">\n                    <div class="mtr-technique" data-id="').concat(a.id,'" data-name="').concat(a.name,'" data-url="').concat(a.url,'">\n                        <span>').concat(e,'</span>\n                    </div>\n                    <div class="mtr-sub-technique-container mtr-display-').concat(g,'""></div>\n                </div>\n            '));a.tactics.forEach((function(a){r.clone().prependTo(t('.mtr-tactic-col[data-tactic="'.concat(a,'"] .mtr-technique-col'),x))}))}})),N&&I.sub_techniques.forEach((function(a){if(""==C||!("platform"in a)||C.some((function(t){return a.platform.indexOf(t)>=0}))){var e="id"==g?a.short_id:a.name;t('.mtr-technique-container[data-id="'.concat(a.technique,'"]'),x).each((function(){t(".mtr-sub-technique-container",t(this)).append('\n                        <div class="mtr-sub-technique mtr-display-'.concat(g,'" data-id="').concat(a.id,'" data-name="').concat(a.name,'" data-url="').concat(a.url,'">\n                            <span>').concat(e,"</span>\n                        </div>\n                    "))}))}})),t(".mtr-tactic-col",x).each((function(){t(".mtr-technique-container[data-id]",this).length||this.remove()})),a.rows.forEach((function(a){var e=r.escapeHtml(a[0]),n=r.escapeHtml(a[1]),i=t('.mtr-technique[data-id="'.concat(e,'"], .mtr-sub-technique[data-id="').concat(e,'"]'),x);if(i&&n&&""!=n&&null!=n&&!isNaN(n)){var c=s._getPercent(v,f,n),o=s._getColor(c),l=r.escapeHtml(a[2])||"";c<2&&(c=2),i.attr("data-value",n),i.attr("data-percent",c),i.attr("data-desc",l),i.css("background",o.background).css("color",o.foreground)}})),t(".mtr-technique, .mtr-sub-technique",x).hover((function(e){var r=t(this).attr("data-id"),n=t(this).attr("data-name"),i=parseInt(t(this).attr("data-percent"))||"",c=t(this).attr("data-desc")||"",o=parseInt(t(this).attr("data-value"))||"",l=t(this).attr("data-url")||"",d=s._getColor(i);i<2&&(i=2);var m=t('\n                <div class="mtr-technique-tooltip">\n                    <div class="mtr-id">'.concat(r,'</div>\n                    <div class="mtr-name">').concat(n,'</div>\n                    <div class="mtr-meter-container">\n                        <div class="mtr-meter-fill"></div>\n                    </div>\n                    <div class="mtr-label"></div>\n                    <div class="mtr-val">').concat(o,'</div>\n                    <div class="mtr-desc"></div>\n                    <div class="mtr-ref"><a target="_blank" href="').concat(l,'">').concat(l,' <i class="icon-external"></i></a></div>\n                </div>\n            '));t(this).offset().left>t(window).width()-400?m.addClass("mtr-technique-tooltip-left"):m.addClass("mtr-technique-tooltip-right");var u="",p=256;if(c.length>p){var h=c.substr(0,p),v=c.substr(p,c.length-p);h=h.split("\\n").join("</p><p>"),v=v.split("\\n").join("</p><p>"),u="<p>".concat(h,' <span class="more-elipses">...</span><span class="more-content">').concat(v,'</span><a href="#" class="more-link">Show more</a></p>')}else u=c.split("\\n").join("</p><p>");t(".mtr-desc",m).append(u),t(".more-link",m).click((function(){return t(".more-elipses",m).hide(),t(".more-content",m).show(),t(".more-link",m).hide(),!1})),m.appendTo(t(this)),o&&(t(".mtr-label",m).text(a.fields[1].name),t(".mtr-meter-fill",m).css("background",d.background).animate({width:t(this).attr("data-percent")+"%"},50,"linear"),d.luminance<.1&&t(".mtr-meter-container",m).addClass("dark"))}),(function(){t(".mtr-technique-tooltip").remove()})),t(".mtr-tactic-col",x).each((function(){var a=0,e=0,r=0;if(t(".mtr-technique",this).each((function(){var n=t(this).attr("data-value");n||!y?(r+=1,n&&!isNaN(n)&&(a+=+n,e+=1)):t(this).parent().remove()})),0==r&&y)t(this).remove();else{var n=Math.round(a/e),i=Math.round(e/r*100);n||(n=0),i||(i=0);var c=s._getPercent(v,f,n),o=s._getColor(c);c<2&&(c=2),t(this).attr("data-value",a),t(".mtr-tactic .mtr-meter-fill",this).css("background",o.background).css("color",o.foreground).css("width",c+"%"),t(".mtr-tactic .mtr-stat",this).css("background",o.background).css("color",o.foreground).css("border-color",o.foreground),t(".mtr-tactic .mtr-total .mtr-stats-val",this).text(a.toLocaleString()),t(".mtr-tactic .mtr-count .mtr-stats-val",this).text(e.toLocaleString()+" (".concat(i,"%)")),t(".mtr-tactic .mtr-mean .mtr-stats-val",this).text(n.toLocaleString())}})),t(".mtr-technique, .mtr-sub-technique, .mtr-tactic",x).each((function(){t(this).click((function(a){var e=t(this).closest(".mtr-tactic-col"),r=t(this).closest(".mtr-technique-container"),n=t(".mtr-technique",r),i=t(this).closest(".mtr-sub-technique"),c={};c["mtr_sub-technique_id"]=i.attr("data-id"),c.mtr_technique_id=n.attr("data-id"),c.mtr_tactic_id=e.attr("data-id"),c["mtr_sub-technique_name"]=i.attr("data-name"),c.mtr_technique_name=n.attr("data-name"),c.mtr_tactic_name=e.attr("data-name"),c["mtr_sub-technique_value"]=i.attr("data-value"),c.mtr_technique_value=n.attr("data-value"),c.mtr_tactic_value=e.attr("data-value"),s._drilldown(c,a)}))})),t(".mtr-technique-col",x).each((function(){s._sortElements(t(this),q,_),t(this).append('\n                <div class="mtr-technique-container mtr-placeholder mtr-display-'.concat(g,'">\n                    <div class="mtr-technique mtr-display-').concat(g,'">\n                        <div class="mtr-technique-title">T0000</div>\n                    </div>\n                </div>\n                <div class="mtr-technique-container mtr-placeholder mtr-display-').concat(g,'">\n                    <div class="mtr-technique mtr-placeholder mtr-display-').concat(g,'">\n                        <div class="mtr-technique-title">T0000</div>\n                    </div>\n                </div>\n            '))})),x.appendTo(this.$el),P.appendTo(this.$el),s.animate){var M=(f-v)/d/60,V=.1*(f-v),A=0;window.requestAnimationFrame((function a(){var e=A,r=e+M+V;s._setAnimationClass(e,r),e<f?A+=M:A=0,s.animate?window.requestAnimationFrame(a):t(".mtr-technique").removeClass("focused").removeClass("defocused")}))}}},getInitialDataParams:function(){return{outputMode:e.ROW_MAJOR_OUTPUT_MODE}},reflow:function(){},_setAnimationClass:function(a,e){t(".mtr-technique").each((function(){var r=t(this).attr("data-value");r&&r>=a&&r<=e?t(this).addClass("focused").removeClass("defocused"):t(this).removeClass("focused").addClass("defocused")}))},_getPercent:function(t,a,e){var r=Math.round(100*(e-t)/(a-t));return r>100&&(r=100),r<0&&(r=0),r},_hexToRgb:function(t){var a=0,e=0,r=0;return 4==t.length?(a="0x"+t[1]+t[1],e="0x"+t[2]+t[2],r="0x"+t[3]+t[3]):7==t.length&&(a="0x"+t[1]+t[2],e="0x"+t[3]+t[4],r="0x"+t[5]+t[6]),{r:a,g:e,b:r}},_getColor:function(t){for(var a=1;a<this.colorMap.length-1&&!(t<this.colorMap[a].pct);a++);var e=this.colorMap[a-1],r=this.colorMap[a],n=r.pct-e.pct,i=(t-e.pct)/n,c=1-i,s=i,o={r:Math.floor(e.color.r*c+r.color.r*s),g:Math.floor(e.color.g*c+r.color.g*s),b:Math.floor(e.color.b*c+r.color.b*s)},l=(.299*o.r+.587*o.g+.114*o.b)/255,d=l>.65?"rgb(0,0,0)":"rgb(255,255,255)";return{background:"rgb("+[o.r,o.g,o.b].join(",")+")",luminance:l,foreground:d}},_sortElements:function(a,e,r){var n="asc"==r?1:-1;$children=a.children().sort((function(a,r){var i=t(".mtr-technique",t(a)),c=t(".mtr-technique",t(r));return"data-id"==e||"data-name"==e?n*(i.attr(e)<c.attr(e)?-1:1):"data-value"==e?(aVal=parseInt(i.attr(e)),bVal=parseInt(c.attr(e)),Number.isInteger(aVal)||(aVal=-1),Number.isInteger(bVal)||(bVal=-1),n*(aVal<bVal?-1:1)):0})),a.append($children)},_drilldown:function(t,a){this.drilldown({action:e.FIELD_VALUE_DRILLDOWN,data:t},a)}})}));